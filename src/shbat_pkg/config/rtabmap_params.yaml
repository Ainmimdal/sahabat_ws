# RTAB-Map Configuration for Gallery Tour Guide Robot with ZED2i
# Optimized for indoor navigation with visual SLAM + wheel odometry fusion

rtabmap:
  ros__parameters:
    # Frame IDs
    # IMPORTANT: This project uses the camera as the odometry root.
    # Use the ZED camera link here to match TF conventions across the stack.
    frame_id: zed2i_camera_link
    odom_frame_id: odom
    map_frame_id: map
    publish_tf: true

    # Subscribe to topics
    subscribe_depth: false
    subscribe_rgb: false
    subscribe_rgbd: true
    subscribe_scan: true  # Use 2D LiDAR for additional features
    subscribe_stereo: false
    subscribe_scan_cloud: false
    subscribe_odom_info: false

    # Synchronization
    approx_sync: true
    sync_queue_size: 10

    # Database
    # Empty = store in ~/.ros/rtabmap.db
    # NOTE: If you run in localization mode (Mem/IncrementalMemory: 'false'),
    #       you MUST have an existing database at this path or RTAB-Map will exit.
    #       For localization, either set this to a specific .db you saved
    #       or ensure ~/.ros/rtabmap.db exists before launching.
    database_path: ""

  # Localization vs mapping
  # NOTE: RTAB-Map's slash-params are parsed as strings by the node.
  # Use quoted strings for these to avoid type errors.
  # Set Mem/IncrementalMemory to 'false' to run in localization mode (no new nodes added)
  Mem/IncrementalMemory: 'true'  # default: mapping mode
  Mem/InitWMWithAllNodes: 'false'

    # RTAB-Map core parameters
    Rtabmap/DetectionRate: '1.0'  # Hz - how often to attempt loop closure
    Rtabmap/TimeThr: '0'  # 0 = no time limit for map update
    Rtabmap/MemoryThr: '0'  # Keep all nodes in WM (for small gallery)
    Rtabmap/StartNewMapOnLoopClosure: 'false'

    # Odometry - we use external wheel+IMU odometry
    Odom/Strategy: '0'  # 0=Frame-to-Map, 1=Frame-to-Frame
    Odom/ResetCountdown: '0'  # Don't reset odometry

    # Visual feature extraction
    Kp/MaxFeatures: '400'  # Features per image
    Kp/DetectorStrategy: '6'  # 0=SURF 1=SIFT 6=GFTT 8=FAST 9=ORB
    Kp/WordsPerImage: '200'

    # Loop closure detection
    Kp/MaxDepth: '10.0'  # meters - max depth for features
    Kp/MinDepth: '0.3'   # meters - min depth (ZED2i minimum range)

    # RGB-D SLAM parameters
    RGBD/Enabled: 'true'
    RGBD/LinearUpdate: '0.1'  # meters - min translation before adding node
    RGBD/AngularUpdate: '0.1'  # radians - min rotation before adding node
    RGBD/OptimizeFromGraphEnd: 'false'
    RGBD/ProximityBySpace: 'true'
    RGBD/ProximityPathMaxNeighbors: '10'

    # Graph optimization
    Optimizer/Strategy: '1'  # 0=TORO 1=g2o 2=GTSAM
    Optimizer/Epsilon: '0.00001'
    Optimizer/Iterations: '100'
    Optimizer/Robust: 'false'

    # Visualization
    Rtabmap/PublishStats: 'true'
    Rtabmap/PublishLikelihood: 'true'
    Rtabmap/PublishPdf: 'true'

    # Grid (for costmap/navigation)
    Grid/Sensor: '0'  # 0=RGB-D
    Grid/CellSize: '0.05'  # meters
    Grid/RangeMax: '5.0'   # meters
    Grid/ClusterRadius: '0.1'
    Grid/GroundIsObstacle: 'false'
    Grid/3D: 'false'  # 2D projection for navigation
    Grid/RayTracing: 'true'
    Grid/MaxObstacleHeight: '2.0'
    Grid/MaxGroundHeight: '0.0'

    # Memory management (tune for Jetson Orin Nano)
    Mem/ImagePreDecimation: '2'  # Reduce image size by 2
    Mem/ImagePostDecimation: '1'
    Mem/STMSize: '30'  # Short-term memory size
    Mem/RehearsalSimilarity: '0.6'

    # ICP (if using scan matching)
    Icp/Iterations: '30'
    Icp/Epsilon: '0.001'
    Icp/MaxCorrespondenceDistance: '0.1'
    Icp/VoxelSize: '0.05'

    # Stereo parameters (for ZED)
    Stereo/MaxDisparity: '128.0'
    Stereo/OpticalFlow: 'true'
